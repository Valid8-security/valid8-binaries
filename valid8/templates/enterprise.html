{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h3 mb-1">Enterprise Dashboard</h1>
                <p class="text-muted">Manage your organization, team seats, and billing</p>
            </div>
            <div>
                <span class="badge bg-primary fs-6">{{ organization.subscription_tier.title() }} Plan</span>
            </div>
        </div>
    </div>
</div>

<!-- Organization Overview -->
<div class="row mb-4">
    <div class="col-md-4 mb-3">
        <div class="card">
            <div class="card-body text-center">
                <i class="bi bi-building text-primary" style="font-size: 2rem;"></i>
                <h5 class="mt-2 mb-1">{{ organization.name }}</h5>
                <small class="text-muted">{{ organization.domain }}</small>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card">
            <div class="card-body text-center">
                <i class="bi bi-people text-success" style="font-size: 2rem;"></i>
                <h5 class="mt-2 mb-1">{{ organization.seats_used }}/{{ organization.seats_allocated }}</h5>
                <small class="text-muted">Seats Used/Allocated</small>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card">
            <div class="card-body text-center">
                <i class="bi bi-graph-up text-info" style="font-size: 2rem;"></i>
                <h5 class="mt-2 mb-1">{{ limits.scans.used if limits.scans else 0 }}</h5>
                <small class="text-muted">Scans This Month</small>
            </div>
        </div>
    </div>
</div>

<!-- Team Management -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Team Members</h5>
                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addSeatModal">
                    <i class="bi bi-plus-circle me-2"></i>Add Member
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>License</th>
                                <th>Last Active</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="teamMembersTable">
                            {% for seat in seats %}
                            <tr>
                                <td>{{ seat.user_name }}</td>
                                <td>{{ seat.user_email }}</td>
                                <td>
                                    <span class="badge bg-secondary">{{ seat.role.title() }}</span>
                                </td>
                                <td>
                                    <code class="small">{{ seat.license_key[:20] }}...</code>
                                </td>
                                <td>
                                    {% if seat.last_active %}
                                        {{ seat.last_active.strftime('%Y-%m-%d') }}
                                    {% else %}
                                        Never
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-danger"
                                            onclick="revokeSeat('{{ seat.user_email }}')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Usage Limits</h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <small>Seats</small>
                        <small>{{ organization.seats_used }}/{{ organization.seats_allocated }}</small>
                    </div>
                    <div class="progress" style="height: 6px;">
                        <div class="progress-bar bg-success"
                             style="width: {{ (organization.seats_used / organization.seats_allocated * 100) if organization.seats_allocated > 0 else 0 }}%">
                        </div>
                    </div>
                </div>

                {% if limits.scans %}
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <small>Monthly Scans</small>
                        <small>{{ limits.scans.used }}/{{ limits.scans.limit or '∞' }}</small>
                    </div>
                    <div class="progress" style="height: 6px;">
                        <div class="progress-bar {{ 'bg-warning' if limits.scans.status == 'warning' else 'bg-danger' if limits.scans.status == 'exceeded' else 'bg-success' }}"
                             style="width: {{ (limits.scans.used / limits.scans.limit * 100) if limits.scans.limit else 0 }}%">
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if limits.api %}
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <small>API Calls</small>
                        <small>{{ limits.api.used }}/{{ limits.api.limit or '∞' }}</small>
                    </div>
                    <div class="progress" style="height: 6px;">
                        <div class="progress-bar {{ 'bg-warning' if limits.api.status == 'warning' else 'bg-danger' if limits.api.status == 'exceeded' else 'bg-success' }}"
                             style="width: {{ (limits.api.used / limits.api.limit * 100) if limits.api.limit else 0 }}%">
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">Subscription Details</h6>
            </div>
            <div class="card-body small">
                <div class="mb-2"><strong>Tier:</strong> {{ organization.subscription_tier.title() }}</div>
                <div class="mb-2"><strong>Support:</strong> {{ organization.support_level.title() }}</div>
                {% if organization.contract_end_date %}
                <div class="mb-2"><strong>Expires:</strong> {{ organization.contract_end_date.strftime('%Y-%m-%d') }}</div>
                {% endif %}
                <div class="mb-2"><strong>Created:</strong> {{ organization.created_at.strftime('%Y-%m-%d') }}</div>

                {% if organization.sso_enabled %}
                <div class="mt-3">
                    <span class="badge bg-info">SSO Enabled</span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Usage Analytics -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Usage Analytics (Last 3 Months)</h5>
            </div>
            <div class="card-body">
                <canvas id="usageChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Add Seat Modal -->
<div class="modal fade" id="addSeatModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Team Member</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addSeatForm">
                    <div class="mb-3">
                        <label for="memberName" class="form-label">Full Name</label>
                        <input type="text" class="form-control" id="memberName" required>
                    </div>
                    <div class="mb-3">
                        <label for="memberEmail" class="form-label">Email Address</label>
                        <input type="email" class="form-control" id="memberEmail" required>
                    </div>
                    <div class="mb-3">
                        <label for="memberRole" class="form-label">Role</label>
                        <select class="form-select" id="memberRole">
                            <option value="developer">Developer</option>
                            <option value="auditor">Security Auditor</option>
                            <option value="admin">Administrator</option>
                            <option value="readonly">Read Only</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addTeamMember()">Add Member</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Usage Analytics Chart
document.addEventListener('DOMContentLoaded', function() {
    const usageData = {{ usage|tojson }};

    const labels = [];
    const scanData = [];
    const apiData = [];

    usageData.forEach(item => {
        const period = new Date(item.period_start);
        labels.push(period.toLocaleDateString('en-US', { month: 'short', year: 'numeric' }));
        scanData.push(item.scans_total);
        apiData.push(item.api_calls_total);
    });

    const ctx = document.getElementById('usageChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Scans',
                data: scanData,
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.4
            }, {
                label: 'API Calls',
                data: apiData,
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
});

async function addTeamMember() {
    const name = document.getElementById('memberName').value;
    const email = document.getElementById('memberEmail').value;
    const role = document.getElementById('memberRole').value;

    if (!name || !email) {
        alert('Please fill in all fields');
        return;
    }

    try {
        const response = await fetch('/api/enterprise/seats', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: name,
                email: email,
                role: role
            })
        });

        const result = await response.json();

        if (response.ok) {
            // Close modal and refresh page
            bootstrap.Modal.getInstance(document.getElementById('addSeatModal')).hide();
            location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        alert('Error adding team member: ' + error.message);
    }
}

async function revokeSeat(email) {
    if (!confirm(`Are you sure you want to remove ${email} from the team?`)) {
        return;
    }

    try {
        const response = await fetch(`/api/enterprise/seats/${email}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            location.reload();
        } else {
            const result = await response.json();
            alert('Error: ' + result.error);
        }
    } catch (error) {
        alert('Error removing team member: ' + error.message);
    }
}
</script>
{% endblock %}

