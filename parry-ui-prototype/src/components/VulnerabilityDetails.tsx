import { AlertTriangle, CheckCircle2, XCircle, ExternalLink, Code, FileCode, Clock, Shield, Zap } from "lucide-react";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "./ui/card";
import { Badge } from "./ui/badge";
import { Button } from "./ui/button";
import { Separator } from "./ui/separator";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "./ui/tabs";

interface VulnerabilityDetailsProps {
  onReviewCode: () => void;
}

export function VulnerabilityDetails({ onReviewCode }: VulnerabilityDetailsProps) {
  const vulnerability = {
    id: "VUL-2024-001",
    severity: "critical",
    type: "SQL Injection",
    title: "Unsanitized User Input in Database Query",
    repository: "backend-api",
    file: "api/users/controller.js",
    lineNumber: 47,
    detectedAt: "2 minutes ago",
    status: "pending",
    confidence: 98,
    cvss: 9.8,
    cwe: "CWE-89",
  };

  const vulnerableCode = `async function getUserById(req, res) {
  const userId = req.params.id;
  
  // Vulnerable code - direct string concatenation
  const query = "SELECT * FROM users WHERE id = '" + userId + "'";
  
  const result = await db.execute(query);
  res.json(result);
}`;

  const fixedCode = `async function getUserById(req, res) {
  const userId = req.params.id;
  
  // Fixed code - using parameterized query
  const query = "SELECT * FROM users WHERE id = ?";
  
  const result = await db.execute(query, [userId]);
  res.json(result);
}`;

  const relatedVulnerabilities = [
    { id: "VUL-2024-002", type: "SQL Injection", file: "api/posts/controller.js", severity: "high" },
    { id: "VUL-2024-015", type: "SQL Injection", file: "api/comments/controller.js", severity: "critical" },
  ];

  const getSeverityColor = (severity: string) => {
    switch (severity) {
      case "critical": return "bg-red-500/10 text-red-500 border-red-500/20";
      case "high": return "bg-orange-500/10 text-orange-500 border-orange-500/20";
      case "medium": return "bg-yellow-500/10 text-yellow-500 border-yellow-500/20";
      case "low": return "bg-green-500/10 text-green-500 border-green-500/20";
      default: return "bg-slate-500/10 text-slate-500 border-slate-500/20";
    }
  };

  return (
    <div className="min-h-screen bg-slate-950 p-6">
      <div className="container mx-auto max-w-7xl">
        {/* Header */}
        <div className="mb-6">
          <div className="flex items-center gap-2 text-slate-400 mb-4">
            <span>Dashboard</span>
            <span>/</span>
            <span>Vulnerabilities</span>
            <span>/</span>
            <span className="text-slate-50">{vulnerability.id}</span>
          </div>
          <div className="flex items-start justify-between">
            <div>
              <div className="flex items-center gap-3 mb-2">
                <Badge className={getSeverityColor(vulnerability.severity)} variant="outline">
                  {vulnerability.severity.toUpperCase()}
                </Badge>
                <h1 className="text-slate-50">{vulnerability.title}</h1>
              </div>
              <p className="text-slate-400">
                {vulnerability.repository} â€¢ {vulnerability.file}:{vulnerability.lineNumber}
              </p>
            </div>
            <div className="flex items-center gap-2">
              <Button variant="outline" className="border-slate-700 text-slate-300">
                <XCircle className="w-4 h-4 mr-2" />
                Dismiss
              </Button>
              <Button onClick={onReviewCode} className="bg-blue-600 hover:bg-blue-700">
                <Code className="w-4 h-4 mr-2" />
                Review & Apply Fix
              </Button>
            </div>
          </div>
        </div>

        <div className="grid lg:grid-cols-3 gap-6">
          {/* Main Content */}
          <div className="lg:col-span-2 space-y-6">
            {/* Vulnerability Overview */}
            <Card className="bg-slate-900 border-slate-800">
              <CardHeader>
                <CardTitle className="text-slate-50">Vulnerability Overview</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="space-y-4">
                  <div>
                    <h3 className="text-slate-300 mb-2">Description</h3>
                    <p className="text-slate-400">
                      This vulnerability allows attackers to inject malicious SQL code through the user ID parameter. 
                      The application directly concatenates user input into SQL queries without proper sanitization or parameterization, 
                      potentially allowing unauthorized database access, data exfiltration, or data manipulation.
                    </p>
                  </div>

                  <Separator className="bg-slate-800" />

                  <div>
                    <h3 className="text-slate-300 mb-2">Attack Vector</h3>
                    <p className="text-slate-400 mb-2">
                      An attacker could craft a malicious request like:
                    </p>
                    <pre className="bg-slate-950 p-3 rounded text-red-400 overflow-x-auto">
{`GET /api/users/1' OR '1'='1`}
                    </pre>
                  </div>

                  <Separator className="bg-slate-800" />

                  <div>
                    <h3 className="text-slate-300 mb-2">Impact</h3>
                    <ul className="list-disc list-inside space-y-1 text-slate-400">
                      <li>Complete database compromise</li>
                      <li>Unauthorized access to sensitive user data</li>
                      <li>Potential data modification or deletion</li>
                      <li>Authentication bypass</li>
                    </ul>
                  </div>
                </div>
              </CardContent>
            </Card>

            {/* AI Fix Suggestion */}
            <Card className="bg-gradient-to-br from-blue-950 to-slate-900 border-blue-500/30">
              <CardHeader>
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-2">
                    <Zap className="w-5 h-5 text-blue-400" />
                    <CardTitle className="text-slate-50">AI-Generated Fix</CardTitle>
                  </div>
                  <Badge className="bg-green-500/20 text-green-400 border-green-500/30" variant="outline">
                    {vulnerability.confidence}% Confidence
                  </Badge>
                </div>
                <CardDescription className="text-slate-400">
                  Automatically generated secure code replacement
                </CardDescription>
              </CardHeader>
              <CardContent>
                <Tabs defaultValue="comparison" className="w-full">
                  <TabsList className="bg-slate-900 border border-slate-800">
                    <TabsTrigger value="comparison">Side-by-Side</TabsTrigger>
                    <TabsTrigger value="vulnerable">Vulnerable Code</TabsTrigger>
                    <TabsTrigger value="fixed">Fixed Code</TabsTrigger>
                  </TabsList>
                  
                  <TabsContent value="comparison" className="mt-4">
                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <div className="flex items-center gap-2 mb-2">
                          <XCircle className="w-4 h-4 text-red-500" />
                          <span className="text-slate-300">Vulnerable</span>
                        </div>
                        <pre className="bg-slate-950 p-4 rounded text-sm text-slate-300 overflow-x-auto border border-red-500/30">
{vulnerableCode}
                        </pre>
                      </div>
                      <div>
                        <div className="flex items-center gap-2 mb-2">
                          <CheckCircle2 className="w-4 h-4 text-green-500" />
                          <span className="text-slate-300">Fixed</span>
                        </div>
                        <pre className="bg-slate-950 p-4 rounded text-sm text-slate-300 overflow-x-auto border border-green-500/30">
{fixedCode}
                        </pre>
                      </div>
                    </div>
                  </TabsContent>

                  <TabsContent value="vulnerable" className="mt-4">
                    <pre className="bg-slate-950 p-4 rounded text-sm text-slate-300 overflow-x-auto">
{vulnerableCode}
                    </pre>
                  </TabsContent>

                  <TabsContent value="fixed" className="mt-4">
                    <pre className="bg-slate-950 p-4 rounded text-sm text-slate-300 overflow-x-auto">
{fixedCode}
                    </pre>
                  </TabsContent>
                </Tabs>

                <div className="mt-4 p-3 bg-slate-900/50 rounded-lg border border-slate-800">
                  <h4 className="text-slate-300 mb-2">Fix Explanation</h4>
                  <p className="text-slate-400">
                    The fix uses parameterized queries (prepared statements) which separate SQL code from user data. 
                    The database driver automatically handles proper escaping and type checking, preventing SQL injection attacks.
                  </p>
                </div>

                <div className="flex gap-2 mt-4">
                  <Button onClick={onReviewCode} className="flex-1 bg-green-600 hover:bg-green-700">
                    <CheckCircle2 className="w-4 h-4 mr-2" />
                    Apply Fix
                  </Button>
                  <Button variant="outline" className="border-slate-700 text-slate-300">
                    <FileCode className="w-4 h-4 mr-2" />
                    View Full Diff
                  </Button>
                </div>
              </CardContent>
            </Card>

            {/* Related Vulnerabilities */}
            <Card className="bg-slate-900 border-slate-800">
              <CardHeader>
                <CardTitle className="text-slate-50">Related Vulnerabilities</CardTitle>
                <CardDescription className="text-slate-400">
                  Similar issues detected in other files
                </CardDescription>
              </CardHeader>
              <CardContent>
                <div className="space-y-3">
                  {relatedVulnerabilities.map((related) => (
                    <div key={related.id} className="flex items-center justify-between p-3 rounded-lg border border-slate-800 hover:border-slate-700 transition-colors">
                      <div className="flex items-center gap-3">
                        <AlertTriangle className={`w-4 h-4 ${related.severity === "critical" ? "text-red-500" : "text-orange-500"}`} />
                        <div>
                          <div className="text-slate-300">{related.type}</div>
                          <div className="text-slate-400">{related.file}</div>
                        </div>
                      </div>
                      <Button size="sm" variant="outline" className="border-slate-700 text-slate-300">
                        View
                      </Button>
                    </div>
                  ))}
                  <Button variant="outline" className="w-full border-blue-500/30 text-blue-400">
                    Apply Batch Fix to All Similar Issues
                  </Button>
                </div>
              </CardContent>
            </Card>
          </div>

          {/* Sidebar */}
          <div className="space-y-6">
            {/* Metrics */}
            <Card className="bg-slate-900 border-slate-800">
              <CardHeader>
                <CardTitle className="text-slate-50">Vulnerability Metrics</CardTitle>
              </CardHeader>
              <CardContent className="space-y-4">
                <div>
                  <div className="flex items-center justify-between mb-1">
                    <span className="text-slate-400">CVSS Score</span>
                    <span className="text-slate-50">{vulnerability.cvss}</span>
                  </div>
                  <div className="text-slate-500">Critical Severity</div>
                </div>

                <Separator className="bg-slate-800" />

                <div>
                  <div className="flex items-center justify-between mb-1">
                    <span className="text-slate-400">CWE ID</span>
                    <span className="text-slate-50">{vulnerability.cwe}</span>
                  </div>
                  <div className="text-slate-500">SQL Injection</div>
                </div>

                <Separator className="bg-slate-800" />

                <div>
                  <div className="flex items-center justify-between mb-1">
                    <span className="text-slate-400">Detected</span>
                    <Clock className="w-4 h-4 text-slate-400" />
                  </div>
                  <div className="text-slate-300">{vulnerability.detectedAt}</div>
                </div>

                <Separator className="bg-slate-800" />

                <div>
                  <div className="flex items-center justify-between mb-1">
                    <span className="text-slate-400">AI Confidence</span>
                    <Shield className="w-4 h-4 text-green-500" />
                  </div>
                  <div className="text-slate-300">{vulnerability.confidence}%</div>
                </div>
              </CardContent>
            </Card>

            {/* Resources */}
            <Card className="bg-slate-900 border-slate-800">
              <CardHeader>
                <CardTitle className="text-slate-50">Resources</CardTitle>
              </CardHeader>
              <CardContent className="space-y-2">
                <Button variant="outline" className="w-full justify-start border-slate-700 text-slate-300 hover:bg-slate-800">
                  <ExternalLink className="w-4 h-4 mr-2" />
                  OWASP SQL Injection Guide
                </Button>
                <Button variant="outline" className="w-full justify-start border-slate-700 text-slate-300 hover:bg-slate-800">
                  <ExternalLink className="w-4 h-4 mr-2" />
                  CWE-89 Documentation
                </Button>
                <Button variant="outline" className="w-full justify-start border-slate-700 text-slate-300 hover:bg-slate-800">
                  <ExternalLink className="w-4 h-4 mr-2" />
                  Parameterized Queries Best Practices
                </Button>
              </CardContent>
            </Card>

            {/* Actions */}
            <Card className="bg-slate-900 border-slate-800">
              <CardHeader>
                <CardTitle className="text-slate-50">Actions</CardTitle>
              </CardHeader>
              <CardContent className="space-y-2">
                <Button variant="outline" className="w-full justify-start border-slate-700 text-slate-300 hover:bg-slate-800">
                  <FileCode className="w-4 h-4 mr-2" />
                  View File in GitHub
                </Button>
                <Button variant="outline" className="w-full justify-start border-slate-700 text-slate-300 hover:bg-slate-800">
                  <ExternalLink className="w-4 h-4 mr-2" />
                  Create Issue
                </Button>
              </CardContent>
            </Card>
          </div>
        </div>
      </div>
    </div>
  );
}
